---
on:
  push: {}
  workflow_dispatch: {}
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
env:
  XDG_CACHE_HOME: ${{ github.workspace }}/.cache/xdg
  POETRY_CACHE_DIR: ${{ github.workspace }}/.cache/poetry
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      image-names: ${{ steps.image-names.outputs.image-names }}
      images-ci: ${{ steps.paths-filter.outputs.images }}
    steps:
      - uses: actions/checkout@v3
      - uses: dorny/paths-filter@v2
        id: paths-filter
        with:
          base: main
          list-files: json
          filters: |
            images:
              - 'images/**'
      - run: |
          set -x
          wget https://github.com/mikefarah/yq/releases/download/v4.25.2/yq_linux_amd64 -O ${GITHUB_WORKSPACE}/yq
          chmod +x ${GITHUB_WORKSPACE}/yq
      - id: image-names
        shell: bash
        run: |
          images=$(echo ${{Â steps.paths-filter.outputs.images_files }} | yq -o=json -I0 '.[] |= sub("images/([^/]+)/.*$", "${1}") | unique' -)
          echo "$images"
          echo "::set-output name=image-names::${images}"
      - run: echo ${{ steps.image-names.outputs.image-names }}

  image-ci:
    runs-on: ubuntu-latest
    needs: ["setup"]
    if: ${{ needs.setup.outputs.images-ci == 'true' }}
    permissions:
      id-token: write
      packages: write
      contents: read
    strategy:
      matrix:
        image: ${{ fromJSON(needs.setup.outputs.image-names) }}
    steps:
      - uses: actions/checkout@v3
      - name: Cache xdg
        uses: actions/cache@v3
        with:
          path: ${{ env.XDG_CACHE_HOME }}
          key: xdg-v1-${{ hashFiles('**/Makefile') }}
          restore-keys: |
            xdg-v1-
      - name: Cache poetry
        uses: actions/cache@v3
        with:
          path: ${{ env.POETRY_CACHE_DIR }}
          key: poetry-v1-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            poetry-v1-
      - name: Cache python venv
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/.venv
          key: pyvenv-v1-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            pyvenv-v1-
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Setup Poetry
        uses: Gr1N/setup-poetry@v7
      - name: Run Poetry Install
        id: toolchain
        shell: bash
        run: |
          poetry install -vvv
      - uses: crazy-max/ghaction-github-runtime@v2.1.0
      - uses: docker/setup-qemu-action@v2.1.0
      - uses: docker/setup-buildx-action@v2.2.1
      - name: Validate python
        run: |
          make VERBOSE=all validate-python
      - name: Build images
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IMAGE_NAMES: ${{ matrix.image }}
        run: |
          export docker_image_build_args="--cache-from type=gha --cache-to type=gha,mode=max"
          make VERBOSE=all validate-static build-images
      - name: Test images
        env:
          IMAGE_NAMES: ${{ matrix.image }}
        run: |
          make VERBOSE=all -j4 test
      - name: Auth to GCP
        if: github.ref == 'refs/heads/main'
        uses: "google-github-actions/auth@v0.8.3"
        with:
          workload_identity_provider: projects/943318002566/locations/global/workloadIdentityPools/github-actions/providers/github-actions-provider
          service_account: gha-docker-images@engineering-production-af50.iam.gserviceaccount.com
          create_credentials_file: true
      - name: Login to GCP artifact registry
        if: github.ref == 'refs/heads/main'
        run: |
          gcloud auth configure-docker europe-north1-docker.pkg.dev
      - name: Push images
        if: github.ref == 'refs/heads/main'
        env:
          IMAGE_NAMES: ${{ matrix.image }}
        run: |
          echo "${{ github.token }}" | docker login https://ghcr.io -u ${{ github.actor }} --password-stdin
          make push-images oci_remote_ref_prefixes=ghcr.io/${{ github.repository }}/e0/
          make push-images oci_remote_ref_prefixes=europe-north1-docker.pkg.dev/engineering-production-af50/images/

  build:
    needs:
      - image-ci
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: exit 1
        name: "Catch errors"
        if: |
          needs.image-ci.result == 'failure'
